# Highload_Cloud_mail.ru
Облако mail.ru - облачный сервис для хренения и обмена файлами, популярный на территории стран СНГ.

### Функционал MVP:
- Регистрация, авторизация;
- Загрузка и удаление файлов;
- Скачивание файла с хранилища;
- Создание директорий и перемещение файлов между ними;
- Показ списка всех файлов директории (листинг);
- Уравление видимостью файлов (доступно всем / доступно только определенным пользователям).

### Целевая аудитория [[1]](#источники):
| Страна             | Процент аудитории | 
|--------------------|-------------------|
| **Россия**         | 86.48%            |
| **Беларусь**       | 3.23%             |
| **Казахстан**      | 3.07%             |
| **Турция**         | 1.32%             |

# Рассчет нагрузки

#### Известно [[2]](#источники):
- MAU (2022): 23 млн пользователей. 
- DAU (2022): 2,5 млн.

#### Предположение:
В 2025 можно взять x1.5 по числу пользователей. 

### Продуктовые метрики:
- 35M MAU;
- 4M DAU;
- Общий объем данных 335 петабайт [[3]](#источники);
- Пользователи загрузили 5,8 млрд файлов (за 2 месяца в 2025) [[3]](#источники).

#### Известно [[3]](#источники):
- Количество хранимых уникальных файлов (2025): 45,5 млрд+.
- Количество уникальных фотографий (2025) составило 28 млрд, а объём — 70 петабайт. 
- Количество видеофайлов составило 2,5 млрд.

#### Предположение:
Пусть средний размер стороннего файла составляет ~5 МБ.
Тогда видео заниют `335 ПБ - 70 ПБ - (15млрд * 5 МБ) = 190 ПБ`
и составляют 56.7% всего хранилища

### Размер хранения:
| Тип файлов         | Количество файлов | Объём (ПБ) | Доля от общего объёма | Средний размер файла |
|--------------------|-------------------|------------|----------------------|----------------------|
| **Фотографии**     | 28 млрд          | 70 ПБ      | 20.9%                 | ~2.5 МБ             |
| **Видео**          | 2,5 млрд         | 190 ПБ     | 56.7%                 | ~76 МБ               |
| **Сторонние файлы**| 15 млрд          | 75 ПБ      | 22.4%                 | ~5 МБ               |
| **Всего**          | 45,5 млрд        | 335 ПБ     | 100%                  | ~7.4 МБ             |


### RRS по API:
| Метод API                     | Формула расчета                          | Средний RPS | Пиковый RPS (x2.5) |
|-------------------------------|------------------------------------------|-------------|---------------------|
| **Авторизация**               | `4 млн / 86400 с`                        | 50          | 125                 |
| **Регистрация**               | `50 RPS * 0.01`                          | 0.5         | 1.3                 |
| **Загрузка файла**            | `2.9 млрд / (31 д * 86400 с)`            | 1100        | 2750                |
| **Удаление файла**            | `1100 RPS * 0.2`                         | 220         | 550                 |
| **Скачивание файла**          | `1100 RPS * 1,5`                         | 1650        | 4125                |
| **Создание директории**       | `50 RPS * 0.1`                           | 5           | 12.5                |
| **Листинг файлов**            | `50 RPS * 5`                             | 250         | 625                 |
| **Изменение видимости файла** | `250 RPS * 15 файлов * 0.05`             | 200         | 500                 |
| **Итого**                     |  `Сумма RPS`                             | **~3500**   | **~8750**           |

*Согласовано с RPS Dropbox с учетом разницы в DAU и MAU [[4]](#источники)

Средний размер файла для загрузки (80% - фото): `0,8 * 2,5 MБ + 0,15 * 5 MБ + 0,05 * 76 MБ = 6.5 MБ`
Средний размер файла для скачивания: `335 ПБ / 45,5 млрд файлов ≈ 7,4 МБ`

| Метод API | Размер данных | Пиковый трафик (Гбит/с) | Суточный трафик (ГБ/сутки) |
| :--- | :---: | :---: | :---: |
| **Загрузка файла** | 6.5 МБ | ~143 | ~600 000 |
| **Скачивание файла** | 7,4 МБ | ~230 | ~1 000 000 |
| **Авторизация** | 10 КБ | ~0.02 | ~8.64 |
| **Регистрация** | 10 КБ | ~0.0002 | ~0.086 |
| **Удаление файла** | 10 КБ | ~0.088 | ~38 |
| **Создание директории** | 10 КБ | ~0.002 | ~0.864 |
| **Листинг файлов** | 30 КБ | ~0.15 | ~648 |
| **Изменение видимости** | 10 КБ | ~0.08 | ~34.56 |
| **ИТОГ** | | ~375 | ~1 600 000 |

# Глобальная балансировка
### Функциональное разбиение по доменам
| Домен | Назначение | Методы API |
| :--- | :--- | :--- |
| **`cloud.mail.ru`** | Главный домен | Авторизация, Регистрация |
| **`meta.cloud.mail.ru`** | Управление метаданными файлов и папок | Создание директории, Листинг, Изменение видимости |
| **`s-XX.data.cloud.mail.ru`** (XX-номер региона) | Операции с файлами | Загрузка, Скачивание, Удаление файлов |

### Расположение ДЦ
Согласно тому, что сервисом в основном пользуются граждане Росси, Беларуси и Казахстана, 
то все ДЦ можно расположить внутри РФ. 

![Карта плотности населения РФ](Federal_subjects_of_Russia_by_population_dencity.svg.png)
Согласно карте плотности населения и списку городов миллионников [[5]](#источники):
| Домен | Города |
| :--- | :--- |
| **`cloud.mail.ru`** | Москва |
| **`meta.cloud.mail.ru`** | Москва |
| **`data.cloud.mail.ru`** (S3)| Москва, СПб, Краснодар, Екатеринбург, Новосибирск, Хабаровск |

### Схема балансировки (Latency-Based DNS для **`data.cloud.mail.ru`**)
- У каждого ДЦ свой домен. Благодаря Latency-Based DNS пользователь перенаправляется на ближайший региональный ДЦ.
- Пользователи загружают/скачивают файлы в основном с одного и того же регионального ДЦ.

# Локальная балансировка
### Схема для доменов **`cloud.mail.ru`** и **`meta.cloud.mail.ru`**
- При помощи DNS весь трафик попадает на один IP в ДЦ
- Затем внутри ДЦ через L4 (Virtual Server via Direct Routing + Keepalived) трафик распределяется на ноды NginX (L7)
- Изменение количества нод NginX автоматически детектится Keepalived и L4 автоматически подстраивается
- На каждой ноде NginX установлен единый TLS session ticket (для Termination SSl)
- NginX реализует least connection балансировку для инстансов бэкенда
- Кластером инстансов бэкенда управляет Kubernetes
#### Дополнительно для **`data.cloud.mail.ru`** (S3) 
- Используются поддомены: api.s-XX.data.cloud.mail.ru, s3.s-XX.data.cloud.mail.ru
##### Загрузка файлов
- Client → data.cloud.mail.ru/upload/* → L4 → L7 → Backend [Auth] → возвращаем клиенту { "upload_url": "https://s3.s-XX/*" }
- Client → s3.s-XX.data.cloud.mail.ru/bucket/* → L4 (SSL Termшination  + HealthCheck, NginX в stream mode) → S3 Gateway → Object Storage
##### Скачивание файлов
- Client → api.s-XX.data.cloud.mail.ru/download/* → L4 → L7 → Backend [Auth] → возвращаем клиенту { "download_url": "https://s3.s-XX/*" }
- Client → s3.s-XX.data.cloud.mail.ru/bucket/* → L4 (SSL Termшination + HealthCheck, NginX в stream mode) → S3 Gateway (Кэширование) → Object Storage

### Формулы резервирования
| Компонент | Схема резервирования |
|-----------|---------------------|
| Backend сервисы | N+1 |
| Nginx L7 | N+1 |

# Логическая схема БД
![Логическая схема БД](db.png)

| Таблица | Назначение |
|---------|------------|
| **UserTable** | Хранение данных пользователей, аутентификация и управление сессиями |
| **Directory** | Организация файловой структуры пользователей, поддержка вложенных папок |
| **FileMetadata** | Хранение метаинформации о файлах без самих файловых данных |
| **FileData** | Связь метаданных с физическим расположением файлов в Object Storage |
| **FileActivity** | Аудит действий пользователей с файлами |
| **FileAссess** | Проверка доступа к файлам |

## Расчет размеров таблиц и QPS

| Название таблицы | Расчеты | Итог | Количество строк | Нагрузка на запись (QPS) | Нагрузка на чтение (QPS) |
|------------------|---------|------|------------------:|--------------------------:|--------------------------:|
| **UserTable** | **Состав:** ID(8) + Login(50) + PasswordHash(60) + Session(256) + ExpireTime(8) + CreatedAt/UpdatedAt(16) = **≈398 B**<br>**Количество записей:** 35,000,000 пользователей | **≈14 ГБ** | **35,000,000** | **1**<br>(авторизация) | **125**<br>(проверка сессий) |
| **Directory** | **Состав:** ID(8) + UserID(8) + DirectoryID(8) + DirName(100) + CreatedAt/UpdatedAt(16) = **≈140 B**<br>**Количество записей:** 35M пользователей × 10 папок = **350,000,000** | **≈49 ГБ** | **350,000,000** | **5**<br>(создание папок) | **250**<br>(листинг директорий) |
| **FileMetadata** | **Состав:** ID(8) + Mode(1) + FileName(100) + FileType(50) + FileVolume(8) + Hash(32) + Url(200) + DirectoryID(8) + CreatedAt/UpdatedAt(16) = **≈424 B**<br>**Количество записей:** 45.5 млрд файлов | **≈19.3 ТБ** | **45,500,000,000** | **1320**<br>(загрузка + удаление) | **1900**<br>(листинг + скачивание) |
| **FileData** | **Источник:** открытые данные [[3]](#источники)<br>**Количество записей:** 45.5 млрд файлов | **335 ПБ** | **45,500,000,000** | **1100**<br>(загрузка файлов) | **1650**<br>(скачивание файлов) |
| **FileActivity** | **Состав:** ID(8) + FileID(8) + UserID(8) + Action(20) + Time(8) = **≈52 B**<br>**Количество записей:** (1650 QPS + 1100 QPS) × 86400 × 30 = **≈7.1 млрд** | **≈370 ГБ** | **7,128,000,000** | **2750**<br>(аудит операций) | **5**<br>(аналитика) |
| **FileAccess** | **Состав:** FileID(8) + UserID(8) + CreatedAt(8) + UpdatedAt(8) = **≈32 B**<br>**Количество записей:** 45.5 млрд файлов × 1.3 = **59,150,000,000** | **≈1.9 ТБ** | **59,150,000,000** | **1520**<br>(создание/удаление/изменение доступа) | **1650**<br>(скачивание файлов) |




# Физическая схема БД
![Физическая схема БД](db-phys.png)

### Индексы
| База данных   | Таблица        | Индексы                          | Пояснение |
|---------------|----------------|-----------------------------------------|-----------|
| **PostgreSQL** | UserTable     | `CREATE INDEX idx_user_login ON UserTable(Login);` | поиск пользователя по логину при аутентификации |
| **PostgreSQL** | UserTable     | `CREATE INDEX idx_user_session ON UserTable(Session);` | поиск пользователя по сессии |
| **PostgreSQL** | Directory     | `CREATE INDEX idx_dir_user_root ON Directory(UserID, DirectoryID);` | поиск родительской директории по пользователю |
| **PostgreSQL** | Directory     | `CREATE INDEX idx_dir_children_name ON Directory(UserID, DirectoryID, DirName);` | поиск вложенных директорий |
| **PostgreSQL** | FileMetadata  | `CREATE INDEX idx_fm_dir_name ON FileMetadata(UserID, DirectoryID, FileName, FileID);` | поиск файлов по директории для листинга |
| **Cassandra**  | FileAccess    | `PRIMARY KEY (FileID, UserID)` | проверка прав доступа: партиционирование по FileID (все права для файла в одной партиции), кластеризация по UserID для проверки доступа |
| **ClickHouse** | FileActivity  | `ORDER BY (time, user_id, file_id)` | первичный индекс для поиска по датам для аналитики |


### Шардирование
| Таблица | Подход | 
|----------------------|-------------|
| **Directory**        | шардирование по UserID при помощи Citus |
| **FileMetadata**     | шардирование по UserID при помощи Citus |
| **FileAccess**       | автошардирование (Cassandra) |
| **FileData**         | автошардирование (Ceph CRUSH) |
| **FileActivity**     | шардирование по дате (ClickHouse) |
#### + FileAccess располоагются рядом с FileData разнесенно по ДЦ.

### Резервирование
| Таблица | Схема резервирования |
|----------------------|----------------------|
| **UserTable**        | Master-Slave с 2 репликами (синхронная и асинхронная) | 
| **Directory**        | Master-Slave с 2 репликами (синхронная и асинхронная) на шард|
| **FileMetadata**     | Master-Slave с 2 репликами (синхронная и асинхронная) на шард |
| **FileAccess**       | Replication Factor = 3 (каждая запись хранится на 3 нодах)|
| **FileData**         | Репликация 3× (Ceph CRUSH) |
| **FileActivity**     | ReplicatedMergeTree (2 реплики на шард) |
| **Kafka** | Replication Factor = 3 (каждая партиция хранится на трех брокерах) |

### Интеграции через Kafka
| Поток | Основные передаваемые данные | Цель |
|--------|----------------------|------------------|
| **Сервис загрузки данных → FileMetadata** | `FileID`, `UserID` `Url`, `Hash`, `Mode` | Асинхронная передача информации о загруженном файле.|
| **Все сервисы → FileActivity (ClickHouse)** | `Time`, `UserID`, `FileID`, `Action` | Поток событий аудита в ClickHouse.|

### Резервное копирование
| База данных          | Частота                 |
|-----------------------|-------------------------|
| PostgreSQL   | backup 1×/день + WAL каждые ≤15 мин |
| Cassandra    | snapshots 1×/день + инкрементальные SSTables каждые ≤3 часа  |
| ClickHouse   | backup 1×/день |
| Ceph         | RGW bucket versioning |
| Kafka | Репликация партиций |

# Алгоритмы

| Алгоритм | Область применения | Мотивация |
|-----------|--------------------|------------|
| **Whole-file hashing** | Дедупликация файлов, оптимизация хранения | Вычисляется один хэш на весь файл. Если два файла имеют одинаковый хэш — они считаются идентичными, и можно хранить только одну копию.|

# Технологии

| Технология                     | Область применения                        | Причины                                                                                                                                                                                                           |
| ------------------------------ | ----------------------------------------- | -----------------|
| **Golang**                | Backend                                   | Компилируемый язык с высокой производительностью и асинхронностью. Развитая экосистема.           |
| **React**                      | Frontend                                  | Позволяет быстро разрабатывать масштабируемые и отзывчивые пользовательские интерфейсы. Компонентный подход упрощает поддержку и повторное использование кода. Активное сообщество и множество готовых библиотек. |
| **Nginx**                      | L7 балансировка нагрузки, прокси          | SSL-терминация, сжатие данных, обратное проксирование и статическое кэширование контента. Высокая производительность и стабильность.                                                                              |
| **Linux Virtual Server (LVS)** | L4 балансировка нагрузки                  | Работает на сетевом уровне. Выполняет балансировку между L7-балансировщиками, не анализируя содержимое пакетов. Обеспечивает высокую производительность.                                                          |
| **Kubernetes**                 | Оркестрация                | Масштабирование через auto-scaling, service discovery, балансировка трафика.                                                                                  |
| **PostgreSQL**                 | Основная база данных сервиса              | Реляционная СУБД с поддержкой транзакций, сложных запросов и индексов. Обеспечивает консистентность и надежность данных.                                                                                          |
| **Cassandra**                  | База данных прав доступа (FileAccess)     | Нереляционная СУБД с горизонтальным масштабированием. Подходит для хранения информации о доступе к файлу.                                       |
| **ClickHouse**                 | Сбор и хранение статистики (FileActivity) | Колонночная СУБД, оптимизированная для аналитических запросов по большим объемам данных. Минимальные затраты ресурсов при высокой скорости.     |
| **Ceph**                       | Хранение файлов (Object Storage)          | S3-совместимое хранилище с горизонтальным масштабированием и отказоустойчивостью. Технология CRUSH автоматически перераспределяет данные.                                                                         |
| **Kafka**                      | Асинхронный обмен данными                 | Используется для передачи событий между сервисами (аудит, загрузка файлов). Высокая пропускная способность и гарантированная доставка сообщений.                                                                 |
| **Prometheus**                 | Мониторинг                                | Сбор метрик сервисов, поддержка alerting, интеграция с Kubernetes.                                                                                                                  |
| **Grafana**                    | Мониторинг               | Построение дашбордов по метрикам, аналитика и гибкая настройка уведомлений. Интеграция с Prometheus.|
| **ClamAV [[6]](#источники)**                    | Антивирус для проверки загружаемых файлов    | Открытое антивирусное решение с поддержкой обновляемых сигнатур и интеграцией через API. Проверяет файлы на вирусы при загрузке|

# Обеспечение надежности

| Компонент                          | Схема резервирования                                                                                                |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------------------- |
| **Backend сервисы (Go)**           | **N+1** –  Управляется через Kubernetes |
| **Nginx (L7 балансировщик)**       | **N+1** – Вне Kubernetes; трафик распределяется через LVS (L4) + Keepalived           |
| **PostgreSQL** | **Primary–Replica (Patroni) с 2 репликами** — одна синхронная, одна асинхронная; автоматический failover. **PgBouncer** для пуллинга подключений. Ежедневный backup + WAL ≤ 15 мин. |
| **Cassandra**                      | **Replication Factor = 3**, каждая запись хранится на 3 нодах. Snapshots 1×/день                      |
| **ClickHouse**                     | **ReplicatedMergeTree** – по 2 реплики на шард. Ежедневное резервное копирование                                   |
| **Ceph**                           | **Репликация 3× (CRUSH)**|
| **Kafka**                          | **Replication Factor = 3** – каждая партиция хранится на трех брокерах.                                          |

# Схема проекта
![Схема проекта](Schema.png)

| Сервис | Назначение |
|:--|:--|
| **User_Service** | Управление пользователями: регистрация, авторизация. |
| **File_Meta_Service** | Управление метаданными и каталогами: создание директорий, листинг, изменение видимости, удаление файлов. Читает из **глобальной Kafka** информацию о загруженных файлах. |
| **Access_Service** | Управление правами доступа и ссылками. Проверяет наличие разрешений при скачивании. |
| **S3 Gateway** | Промежуточный слой между клиентом и объектным хранилищем **Ceph (S3)**. Выполняет:<br>• Кэширование часто запрашиваемых объектов,<br>• Вычисление **Whole-file hash** для дедупликации,<br>• Fast scan для файлов <10 МБ через `AV_Scanner`,<br>• Отправку события `file_uploaded` → **локальная Kafka** для асинхронной антивирусной проверки,<br>• После успешной загрузки (независимо от антивирусной проверки) — публикацию события `file_uploaded` → **глобальная Kafka** для обновления метаданных. |
| **AV_Scanner** | Проверяет загруженные файлы на вирусы (**ClamAV**) с использованием базы **Malware Signatures**. Получает задания из **локальной Kafka**, сканирует содержимое в Ceph и публикует результат в **глобальную Kafka**. После проверки обновляется `FileMetadata.mode` — файл становится доступен для скачивания. |
| **Metrics_Service** | Консьюмер Kafka, агрегирует события загрузок/скачиваний/изменений и записывает статистику в **ClickHouse FileActivity** для аналитики и мониторинга. |

## Для загрузки
### Выбор региона
- Client → `https://meta.cloud.mail.ru...` → `L4` → `L7` → **File_Meta_Service** → { FileID: "..." }.
- Client → DNS `data.cloud.mail.ru` → попадаем в **ближайший региональный ДЦ**.  
- **Access_Service** на `https://data.cloud.mail.ru/upload/*` выдает { "upload_url": "https://s3.s-XX..." }.
  > `s-XX` — регион текущего ДЦ, выбранного DNS.

### A. Синхронно (<10 MB)
1. Client → `https://s3.s-XX…` → `L4` → **S3 Gateway**.  
2. **S3 Gateway**: валидация, `whole-file hash`, **sync fast scan**, запись в Ceph.  
3. Публикует `file_uploaded` в **глобальную Kafka** (загружен и проверен).
4. **File_Meta_Service** обновляет метаданные, читая из **глобальной Kafka**.  

### B. Асинхронно (≥10 MB)
1. Client → `https://s3.s-XX…` → `L4` → **S3 Gateway**.  
2. **S3 Gateway**: валидация, `whole-file hash`, запись в Ceph со статусом `pending`.  
3. Публикует `file_uploaded` в **локальную Kafka** для антивирусной проверки и `file_uploaded` в **глобальную Kafka** (загружен, но не проверен).  
4. **AV_Scanner** читает локальный топик, сканирует объект, публикует `av_result` в **глобальную Kafka** (загружен и проверен).  
5. **File_Meta_Service** обновляет метаданные, читая из **глобальной Kafka** .

## Для скачивания
### Узнаем, где хранится файл
Client → `https://meta.cloud.mail.ru...` → `L4` → `L7` → **File_Meta_Service** → { url: "api.s-XX..." }.

### Обращаемся сразу в нужный регион (без DNS-баланса) 
Client → `https://api.s-XX...` → `L4` → `L7` → **Access_Service** → { "download_url": "https://s3.s-XX..." }

### Скачивание данных 
Client → `download_url` → `L4` → **S3 Gateway** → (cache) → **Ceph (S3)**.  

# Расчет ресурсов
### Расчет ресурсов (центральный кластер: Москва)
| Компонент               | Пиковый RPS | Характер сервиса         | CPU | RAM       | Трафик |
|-------------------------|-------------|---------------------------|-----|-----------|--------|
| **User_Service**         | ~125         | Лёгкое JSON API           | 1   | ~0.01 GB  | ~1 Мбит/с |
| **File_Meta_Service**    | ~4438        | Средняя бизнес-логика     | 45  | ~4.5 GB   | ~5 Мбит/с |
| **Metrics_Service**      | ~7925        | Средняя бизнес-логика     | 80  | ~8 GB     | ~20 Мбит/с |
| **NGINX (L7: cloud/meta)** | ~4500     | SSL Term + Proxy          | 9   | ~0.09 GB  | ~40–50 Мбит/с |

### Примерная нагрузка на один регион (Москва, СПб, Краснодар, Екатеринбург, Новосибирск, Хабаровск)
| Компонент             | Пиковый RPS | Характер сервиса         | CPU | RAM       | Трафик (на регион) |
|-----------------------|-------------|---------------------------|-----|-----------|---------------------|
| **Access_Service**     | ~1146       | Средняя бизнес-логика     | 12  | ~1.2 GB   | ~16 Мбит/с |
| **AV_Scanner**         | ~1146       | Тяжёлая бизнес-логика     | 115 | ~11.5 GB  | ~6 Гбит/с |
| **S3 Gateway**         | ~1146       | Тяжёлая бизнес-логика     | 115 | ~11.5 GB  | ~62 Гбит/с |
| **NGINX (L7: data)**   | ~1146       | SSL Term + Proxy          | 3   | ~0.03 GB  | ~16 Мбит/с |
| **NGINX (L4, stream)** | ~1146       | L4 passthrough            | 3   | ~0.03 GB  | ~62 Гбит/с |

| Компонент            | Где запускаем |
|----------------------|----------------|
| **User_Service**         | Kubernetes     | 
| **File_Meta_Service**    | Kubernetes     | 
| **Access_Service**       | Kubernetes     | 
| **Metrics_Service**      | Kubernetes     | 
| **Nginx (L7)**           | Bare metal     | 
| **S3 Gateway**           | Bare metal     | 
| **AV_Scanner**           | Bare metal     | 
| **Nginx (L4, stream)**   | Bare metal     | 



### Источники:
1. [Be1.ru - Статистика Cloud.Mail.ru](https://be1.ru/stat/cloud.mail.ru)
2. [habr.com - данные о пользователях за 2022](https://habr.com/ru/news/711772/?ysclid=mfbpt8ybjf200216558)
3. [habr.com - данные о данных в 2025](https://habr.com/ru/news/887932/)
4. [brizfeel.com - статистика Dropbox](https://brizfeel.com/dropbox-subscribers-users-statistics/)
5. [Риа Новости - города миллионники РФ](https://ria.ru/20250226/goroda-1832007799.html?ysclid=mfza7mes6l4067739)
6. [ClamAV - антивирус](https://mivocloud.com/ru/blog/ClamAV-Nadezhnaya-zashchita-ot-virusov-dlya-Linux-i-drugikh-sistem)
